<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Medisch Verslag</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    button { padding: 10px; font-size: 1em; margin-top: 10px; width: 100%; }
    .recording { background-color: red; color: white; }
    .stopping { background-color: blue; color: white; }
    textarea { width: 100%; min-height: 200px; margin-top: 10px; font-family: monospace; }
    .copy-button { margin-top: 5px; background: #444; color: white; border: none; padding: 8px 12px; cursor: pointer; }
    select { width: 100%; padding: 8px; margin: 10px 0; }
    input[type="file"] { width: 100%; padding: 8px; margin: 10px 0; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>🩺 Medisch verslag</h1>
  
  {% if user %}
  <div style="background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
    <div>
      <strong>👤 Ingelogd als:</strong> {{ user.full_name }} ({{ user.username }})
      <br><small>📧 {{ user.email }}</small>
    </div>
    <a href="/logout" style="background: #f44336; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-size: 14px;">🚪 Uitloggen</a>
  </div>
  {% endif %}
  
  <div class="warning">
    <strong>⚠️ Belangrijk:</strong> Dit systeem is bedoeld als hulpmiddel. Controleer altijd de output en gebruik uw medische expertise voor de finale beoordeling.
  </div>

  <form id="uploadForm" method="post" action="/transcribe" enctype="multipart/form-data">
    <label for="verslag_type">Type verslag:</label>
    <select id="verslag_type" name="verslag_type" required>
      <option value="TTE">🫀 TTE - Transthoracale echocardiografie</option>
      <option value="TEE">🔍 TEE - Transesofageale echocardiografie</option>
      <option value="Spoedconsult">🚨 Spoedconsult - Urgente cardiologische evaluatie</option>
      <option value="Raadpleging">📋 Raadpleging - Volledige consultatieverslagen</option>
      <option value="Consult">👨‍⚕️ Consult - Volledige consultatieverslagen</option>
      <option value="Vrij dictaat">📝 Vrij dictaat - Professioneel verslag zonder template</option>
    </select>
    <input type="file" name="audio_file" accept="audio/*" />
    
    <div style="margin: 10px 0;">
      <label>
        <input type="checkbox" name="disable_hallucination_detection" value="true" style="margin-right: 8px;">
        🔧 Schakel hallucinatiedetectie uit
      </label>
    </div>
    
    <button type="submit">📤 Upload en verwerk</button>
  </form>

  <button id="recordBtn" onclick="toggleRecord()">🔴 Start opname</button>
  <audio id="preview" controls style="margin-top:10px; display:none;"></audio>

  <form id="recordUploadForm" method="post" action="/transcribe" enctype="multipart/form-data" style="display:none;">
    <input type="hidden" name="verslag_type" value="TTE" />
    <input type="file" name="audio_file" id="recordedAudioInput" />
  </form>

  {% if error %}
  <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; margin: 10px 0; border-radius: 5px;">
    <strong>{{ error }}</strong>
  </div>
  {% endif %}

  <h2>Verslag {% if structured %}✅ Quality Control{% endif %}</h2>
  <textarea id="verslagText" readonly>{{ structured or transcript }}</textarea>
  <div style="display: flex; gap: 10px; margin-top: 10px;">
    <button class="copy-button" onclick="copyToClipboard('verslagText')">📋 Kopieer verslag</button>
    {% if structured %}
    <button class="copy-button" onclick="verbeterVerslag()" style="background-color: #28a745;">✨ Verbeter</button>
    {% endif %}
  </div>

  {% if advies %}
  <h2>📘 Advies volgens ESC/AHA</h2>
  <textarea id="adviesText" readonly>{{ advies }}</textarea>
  <button class="copy-button" onclick="copyToClipboard('adviesText')">📋 Kopieer aanbevelingen</button>
  {% endif %}

  <script>
    let mediaRecorder;
    let recordedChunks = [];

    function toggleRecord() {
      const btn = document.getElementById('recordBtn');
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        btn.textContent = '🔴 Start opname';
        btn.className = '';
      } else {
        startRecording();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'audio/wav' });
          const url = URL.createObjectURL(blob);
          
          const preview = document.getElementById('preview');
          preview.src = url;
          preview.style.display = 'block';

          // Automatically download the recorded audio
          const downloadLink = document.createElement('a');
          downloadLink.href = url;
          downloadLink.download = `opname_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.wav`;
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          // Create file for upload
          const file = new File([blob], 'recording.wav', { type: 'audio/wav' });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          
          // Update both file inputs
          const mainFileInput = document.querySelector('#uploadForm input[name="audio_file"]');
          const recordFileInput = document.querySelector('#recordUploadForm input[name="audio_file"]');
          
          mainFileInput.files = dataTransfer.files;
          recordFileInput.files = dataTransfer.files;
          
          // Update the recording form with current verslag type
          const currentType = document.getElementById('verslag_type').value;
          document.querySelector('#recordUploadForm input[name="verslag_type"]').value = currentType;
          
          // Show upload button for recorded audio
          const uploadBtn = document.createElement('button');
          uploadBtn.textContent = '📤 Upload opname';
          uploadBtn.type = 'button';
          uploadBtn.onclick = () => {
            document.getElementById('uploadForm').submit();
          };
          uploadBtn.style.marginTop = '10px';
          uploadBtn.style.width = '100%';
          uploadBtn.style.padding = '10px';
          uploadBtn.style.fontSize = '1em';
          
          // Remove existing upload button if present
          const existingBtn = document.getElementById('uploadRecordingBtn');
          if (existingBtn) existingBtn.remove();
          
          uploadBtn.id = 'uploadRecordingBtn';
          preview.parentNode.insertBefore(uploadBtn, preview.nextSibling);
        };

        mediaRecorder.start();
        const btn = document.getElementById('recordBtn');
        btn.textContent = '⏹️ Stop opname';
        btn.className = 'recording';
      } catch (err) {
        alert('Fout bij toegang tot microfoon: ' + err.message);
      }
    }

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      element.select();
      document.execCommand('copy');
      
      const button = element.nextElementSibling;
      const originalText = button.textContent;
      button.textContent = '✅ Gekopieerd!';
      setTimeout(() => {
        button.textContent = originalText;
      }, 2000);
    }

    // Verbeter verslag function
    function verbeterVerslag() {
      const verslagText = document.getElementById('verslagText').value;
      const verslagType = '{{ verslag_type }}';
      
      if (!verslagText) {
        alert('Geen verslag om te verbeteren');
        return;
      }
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '⏳ Verbeteren...';
      btn.disabled = true;
      
      // Send request to improve the report
      fetch('/verbeter', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          verslag: verslagText,
          verslag_type: verslagType
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('verslagText').value = data.verbeterd_verslag;
        } else {
          alert('Fout bij verbeteren: ' + data.error);
        }
      })
      .catch(error => {
        alert('Fout bij verbeteren: ' + error);
      })
      .finally(() => {
        btn.textContent = originalText;
        btn.disabled = false;
      });
    }

    // Update recording form when verslag type changes
    document.getElementById('verslag_type').addEventListener('change', function() {
      document.querySelector('#recordUploadForm input[name="verslag_type"]').value = this.value;
    });
  </script>
</body>
</html>

